

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xamla_motion.motion_service &mdash; xamla_motion 0.0.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #57678d" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/rosvita-docs-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Package Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/quick_start.html">Quick start guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/motion_client.html">Motion client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/motion_client_v2.html">Motion client version 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/gripper_client.html">Gripper client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/world_view_client.html">WorldView client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/world_view_client_v2.html">WorldViewClient version 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/motion_service.html">Motion Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/data_types.html">Data types</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xamla_motion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>xamla_motion.motion_service</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xamla_motion.motion_service</h1><div class="highlight"><pre>
<span></span><span class="c1"># motion_service.py</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2018, Xamla and/or its affiliates. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software; you can redistribute it and/or</span>
<span class="c1"># modify it under the terms of the GNU General Public License</span>
<span class="c1"># as published by the Free Software Foundation; either version 2</span>
<span class="c1"># of the License, or any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program; if not, write to the Free Software</span>
<span class="c1"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>

<span class="c1">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">enum</span>

<span class="kn">from</span> <span class="nn">xamlamoveit_msgs.srv</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">xamlamoveit_msgs.msg</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">control_msgs.msg</span> <span class="k">import</span> <span class="n">GripperCommandAction</span><span class="p">,</span> <span class="n">GripperCommandGoal</span>
<span class="kn">from</span> <span class="nn">moveit_msgs.msg</span> <span class="k">import</span> <span class="n">MoveItErrorCodes</span>
<span class="kn">from</span> <span class="nn">std_srvs.srv</span> <span class="k">import</span> <span class="n">SetBool</span>

<span class="kn">from</span> <span class="nn">.xamla_motion_exceptions</span> <span class="k">import</span> <span class="n">ServiceException</span><span class="p">,</span> <span class="n">ArgumentError</span>
<span class="kn">from</span> <span class="nn">.data_types</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utility</span> <span class="k">import</span> <span class="n">ROSNodeSteward</span><span class="p">,</span> <span class="n">LeaseBaseLock</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Iterable</span>

<span class="kn">from</span> <span class="nn">actionlib_msgs.msg</span> <span class="k">import</span> <span class="n">GoalID</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">asyncio</span>


<span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">ActionLibGoalStatus</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">PREEMPTED</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">SUCCEEDED</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ABORTED</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">PREEMPTING</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">RECALLING</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">RECALLED</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">LOST</span> <span class="o">=</span> <span class="mi">9</span>


<span class="k">def</span> <span class="nf">generate_action_executor</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">run_action</span><span class="p">(</span><span class="n">goal</span><span class="p">):</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="n">action_done</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">done_callback</span><span class="p">(</span><span class="n">goal_status</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ActionLibGoalStatus</span><span class="p">(</span><span class="n">goal_status</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">ActionLibGoalStatus</span><span class="o">.</span><span class="n">SUCCEEDED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">reason</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
                        <span class="n">exc</span> <span class="o">=</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;action end unsuccessfully with&#39;</span>
                                               <span class="s1">&#39; state: </span><span class="si">{}</span><span class="s1">, reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">,</span>
                                                                               <span class="n">reason</span><span class="p">),</span>
                                               <span class="n">error_code</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="n">exc</span> <span class="o">=</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;action end unsuccessfully with&#39;</span>
                                               <span class="s1">&#39; state: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>

                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">action_done</span><span class="o">.</span><span class="n">set_exception</span><span class="p">,</span>
                                              <span class="n">exc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">action_done</span><span class="o">.</span><span class="n">set_result</span><span class="p">,</span>
                                              <span class="n">result</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span> <span class="n">done_cb</span><span class="o">=</span><span class="n">done_callback</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">action_done</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">exc</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">action_done</span>

    <span class="k">return</span> <span class="n">run_action</span>


<span class="k">class</span> <span class="nc">SteppedMotionClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Client to perform supervised trajectory execution</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    moveJ_supervised</span>
<span class="sd">        Run supervised trajectory execution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__step_topic</span> <span class="o">=</span> <span class="s1">&#39;/xamlaMoveActions/step&#39;</span>
    <span class="n">__next_topic</span> <span class="o">=</span> <span class="s1">&#39;/xamlaMoveActions/next&#39;</span>
    <span class="n">__previous_topic</span> <span class="o">=</span> <span class="s1">&#39;/xamlaMoveActions/prev&#39;</span>
    <span class="n">__feedback_topic</span> <span class="o">=</span> <span class="s1">&#39;/xamlaMoveActions/feedback&#39;</span>
    <span class="n">__movej_action_name</span> <span class="o">=</span> <span class="s1">&#39;moveJ_step_action&#39;</span>

    <span class="k">class</span> <span class="nc">__ShutdownManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_shutdown</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># print(&#39;stepped shutdown&#39;)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cancel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># print(&#39;cancel goal_id: {}&#39;.format(key))</span>
                <span class="n">cancel</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">register_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_id</span><span class="p">,</span> <span class="n">cancel_func</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">goal_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancel_func</span>
                <span class="c1"># keys = [key for key in self.instances]</span>
                <span class="c1"># print(&#39;instances after add: {}&#39;.format(keys))</span>

        <span class="k">def</span> <span class="nf">unregister_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_id</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">goal_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># keys = [key for key in self.instances]</span>
                <span class="c1"># print(&#39;instances after pop: {}&#39;.format(keys))</span>

    <span class="n">__shutdown_manager</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">JointTrajectory</span><span class="p">,</span>
                 <span class="n">velocity_scaling</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">check_collision</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run supervised trajectory execution</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trajectory : JointTrajectory</span>
<span class="sd">            Trajectory which should be executed supervised</span>
<span class="sd">        velocity_scaling : float</span>
<span class="sd">            Scaling factor to reduce or increase the trajectory</span>
<span class="sd">            velocities range [0.0-1.0]</span>
<span class="sd">        check_collision : bool (default True)</span>
<span class="sd">            If True collision check is performed</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If trajectory is not of expected type JointTrajectory</span>
<span class="sd">        ValueError</span>
<span class="sd">            If velocity_scaling is not in range between 0.0 an 1.0</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If action goal handle is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mutex</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__shutdown_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__shutdown_manager</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__ShutdownManager</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__ros_node_steward</span> <span class="o">=</span> <span class="n">ROSNodeSteward</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__movej_action_name</span><span class="p">,</span>
                                                       <span class="n">StepwiseMoveJAction</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;connection to stepped motion action&#39;</span>
                                   <span class="s1">&#39; server could not be established&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__progress</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">JointTrajectory</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;trajectory is not of expected type&#39;</span>
                            <span class="s1">&#39; JointTrajectory&#39;</span><span class="p">)</span>

        <span class="n">goal</span> <span class="o">=</span> <span class="n">StepwiseMoveJGoal</span><span class="p">()</span>
        <span class="n">velocity_scaling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">velocity_scaling</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">velocity_scaling</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="n">velocity_scaling</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;velocity scaling is not between 0.0 and 1.0&#39;</span><span class="p">)</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">veloctiy_scaling</span> <span class="o">=</span> <span class="n">velocity_scaling</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">check_collision</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">check_collision</span><span class="p">)</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">to_joint_trajectory_msg</span><span class="p">()</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__action_done</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__action_done</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_done_callback</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">done_callback</span><span class="p">(</span><span class="n">goal_status</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ActionLibGoalStatus</span><span class="p">(</span><span class="n">goal_status</span><span class="p">)</span>

            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__shutdown_manager</span><span class="o">.</span><span class="n">unregister_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">ActionLibGoalStatus</span><span class="o">.</span><span class="n">SUCCEEDED</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">reason</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
                        <span class="n">exc</span> <span class="o">=</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;action end unsuccessfully with&#39;</span>
                                               <span class="s1">&#39; state: </span><span class="si">{}</span><span class="s1">, reason: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">,</span>
                                                                               <span class="n">reason</span><span class="p">),</span>
                                               <span class="n">error_code</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">exc</span> <span class="o">=</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;action end unsuccessfully with&#39;</span>
                                               <span class="s1">&#39; state: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>

                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__action_done</span><span class="o">.</span><span class="n">set_exception</span><span class="p">,</span>
                                              <span class="n">exc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__action_done</span><span class="o">.</span><span class="n">set_result</span><span class="p">,</span>
                                              <span class="n">result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span> <span class="n">done_cb</span><span class="o">=</span><span class="n">done_callback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">gh</span><span class="o">.</span><span class="n">comm_state_machine</span><span class="o">.</span><span class="n">action_goal</span><span class="o">.</span><span class="n">goal_id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;action goal handle is not available&#39;</span><span class="p">)</span>

        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__shutdown_manager</span><span class="o">.</span><span class="n">register_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="n">SteppedMotionState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__step_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__step_topic</span><span class="p">,</span>
                                          <span class="n">Step</span><span class="p">,</span>
                                          <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__next_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__next_topic</span><span class="p">,</span>
                                          <span class="n">GoalID</span><span class="p">,</span>
                                          <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__previous_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__previous_topic</span><span class="p">,</span>
                                              <span class="n">GoalID</span><span class="p">,</span>
                                              <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__feedback_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__feedback_topic</span><span class="p">,</span>
                                               <span class="n">TrajectoryProgress</span><span class="p">,</span>
                                               <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_feedback_callback</span><span class="p">,</span>
                                               <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__shutdown_manager</span><span class="o">.</span><span class="n">unregister_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__shutdown_manager</span><span class="o">.</span><span class="n">unregister_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ServiceException</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        state : SteppedMotionState or None</span>
<span class="sd">            Current state of the supervised trajectory execution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mutex</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">goal_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        goal_id : GoalId or None</span>
<span class="sd">            Current ros action goal id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">action_done_future</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        action_done_future : asyncio.future</span>
<span class="sd">            future which is done when supervised move is done of cancelled</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__action_done</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">velocity_scaling</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requests the supervised executor to perform a step</span>

<span class="sd">        The stepping direction is determined by the sign of the velocity_scaling</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        velocity_scaling : float</span>
<span class="sd">            Specifies the desired velocity and direction of the supervised motion.</span>
<span class="sd">            Positive values mean forward and negative values backward stepping.</span>
<span class="sd">            To stop fast as possible set velocity scaling to 0.0.</span>
<span class="sd">            Valid range: [-1.0, 1.0]</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If velocity_scaling is not between -1.0 and 1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">velocity_scaling</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.00001</span> <span class="ow">or</span> <span class="n">velocity_scaling</span> <span class="o">&gt;</span> <span class="mf">1.00001</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;velocity scaling is not in range [-1.0, 1.0]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">Step</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_id</span><span class="o">.</span><span class="n">id</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">velocity_scaling</span> <span class="o">=</span> <span class="n">velocity_scaling</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__step_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request at supervised executor to perform next step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__next_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">previous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request at supervised executor to perform previous step</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__previous_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_feedback_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_progress</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__progress</span> <span class="o">!=</span> <span class="n">trajectory_progress</span><span class="o">.</span><span class="n">progress</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mutex</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__progress</span> <span class="o">=</span> <span class="n">trajectory_progress</span><span class="o">.</span><span class="n">progress</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="n">SteppedMotionState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__goal_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                  <span class="n">trajectory_progress</span><span class="o">.</span><span class="n">error_msg</span><span class="p">,</span>
                                                  <span class="n">trajectory_progress</span><span class="o">.</span><span class="n">error_code</span><span class="p">,</span>
                                                  <span class="n">trajectory_progress</span><span class="o">.</span><span class="n">progress</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="c1"># print(&#39;done callback&#39;)</span>
        <span class="c1"># type(self).__shutdown_manager.unregister_instance(self.__goal_id.id)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__feedback_sub</span><span class="o">.</span><span class="n">unregister</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__step_pub</span><span class="o">.</span><span class="n">unregister</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__next_pub</span><span class="o">.</span><span class="n">unregister</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__previous_pub</span><span class="o">.</span><span class="n">unregister</span><span class="p">()</span>


<div class="viewcode-block" id="MotionService"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService">[docs]</a><span class="k">class</span> <span class="nc">MotionService</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">__movej_action</span> <span class="o">=</span> <span class="s1">&#39;moveJ_action&#39;</span>
    <span class="n">__query_inverse_kinematics_service</span> <span class="o">=</span> <span class="s2">&quot;xamlaMoveGroupServices/query_ik2&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__ros_node_steward</span> <span class="o">=</span> <span class="n">ROSNodeSteward</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ik_service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__query_inverse_kinematics_service</span><span class="p">,</span>
                <span class="n">GetIKSolution2</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;init service for query&#39;</span>
                                   <span class="s1">&#39; inverse kinematics failed,&#39;</span>
                                   <span class="s1">&#39; abort &#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__movej_action</span><span class="p">,</span>
                                                       <span class="n">moveJAction</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;connection to moveJ action&#39;</span>
                                   <span class="s1">&#39; server could not be established&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MotionService.query_available_move_groups"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_available_move_groups">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_available_move_groups</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query all currently available move groups</span>

<span class="sd">        To query the move groups the ros service with the string</span>
<span class="sd">        defined in query_move_group_service is called</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        groups : List[MoveGroupDescription]</span>
<span class="sd">            Returns a list with instances of MoveGroupDescription.</span>
<span class="sd">            For further details please take a look into the documentation</span>
<span class="sd">            of MoveGroupDescription</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        xamla_motion.ServiceNotAvailableException</span>
<span class="sd">            If Service not exist or is not callable</span>
<span class="sd">        TypeError</span>
<span class="sd">            If the service response joint_names are not</span>
<span class="sd">            of an iterable type</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_move_group_service</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaMoveGroupServices/&#39;</span>
                                    <span class="s1">&#39;query_move_group_interface&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_move_group_service</span><span class="p">,</span>
                <span class="n">QueryMoveGroupInterfaces</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; available move groups failed,&#39;</span>
                                   <span class="s1">&#39; abort &#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">move_group_interfaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">joint_set</span> <span class="o">=</span> <span class="n">JointSet</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">joint_set</span> <span class="o">=</span> <span class="n">JointSet</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MoveGroupDescription</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">sub_move_group_ids</span><span class="p">,</span>
                                               <span class="n">joint_set</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">end_effector_names</span><span class="p">,</span>
                                               <span class="n">g</span><span class="o">.</span><span class="n">end_effector_link_names</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">groups</span></div>

<div class="viewcode-block" id="MotionService.query_available_end_effectors"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_available_end_effectors">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_available_end_effectors</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query all currently available end effectors</span>

<span class="sd">        To query the available end effectors the ros service with the string</span>
<span class="sd">        defined in _query_move_group_service is called an only the relevant</span>
<span class="sd">        information about the endeffector is filtered out</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        end_effectors : Dict[str, EndEffectorDescription]</span>
<span class="sd">            Returns a dictionary key is the endeffector name,</span>
<span class="sd">            value is an instance of EndEffectorDescription</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        xamla_motion.ServiceExeption</span>
<span class="sd">            If Service not exist or is not callable</span>
<span class="sd">        TypeError</span>
<span class="sd">            If the service response joint_names are not</span>
<span class="sd">            of an iterable type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">move_groups</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_available_move_groups</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ServiceException</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span>

        <span class="n">end_effectors</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">move_groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">end_effector</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">end_effector_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">end_effector</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">end_effectors</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">EndEffectorDescription</span><span class="p">(</span><span class="n">end_effector</span><span class="p">,</span>
                                               <span class="n">group</span><span class="o">.</span><span class="n">sub_move_group_ids</span><span class="p">,</span>
                                               <span class="n">group</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                               <span class="n">group</span><span class="o">.</span><span class="n">end_effector_link_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                    <span class="n">end_effectors</span><span class="p">[</span><span class="n">end_effector</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>

        <span class="k">return</span> <span class="n">end_effectors</span></div>

<div class="viewcode-block" id="MotionService.query_endeffector_limits"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_endeffector_limits">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_endeffector_limits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query end effector limits from ros param</span>

<span class="sd">        To query the end effector limits the ros param definied in</span>
<span class="sd">        end_effector_limits_param is read out</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str convertable</span>
<span class="sd">            Name of the end effector for which the</span>
<span class="sd">            limits are queried</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        EndEffectorLimits</span>
<span class="sd">            Returns a instance of EndEffectorLimits</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the the ros parameter or</span>
<span class="sd">            the requested end effector name</span>
<span class="sd">            no exists</span>
<span class="sd">        KeyError</span>
<span class="sd">            If not all necessary limits exists</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">end_effector_limits_param</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaJointJogging/&#39;</span>
                                     <span class="s1">&#39;end_effector_list&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">eel_param</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">end_effector_limits_param</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;end effector limit ros param: &#39;</span>
                               <span class="o">+</span> <span class="n">end_effector_limits_param</span> <span class="o">+</span>
                               <span class="s1">&#39; not exists&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">limits</span> <span class="ow">in</span> <span class="n">eel_param</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">end_effector_name</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">end_effector_name</span><span class="p">:</span>
                <span class="n">max_xyz_vel</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;taskspace_xyz_max_vel&#39;</span><span class="p">]</span>
                <span class="n">max_xyz_acc</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;taskspace_xyz_max_acc&#39;</span><span class="p">]</span>
                <span class="n">max_angular_vel</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;taskspace_angular_max_vel&#39;</span><span class="p">]</span>
                <span class="n">max_angular_acc</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="s1">&#39;taskspace_angular_max_acc&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">EndEffectorLimits</span><span class="p">(</span><span class="n">max_xyz_vel</span><span class="p">,</span>
                                         <span class="n">max_xyz_acc</span><span class="p">,</span>
                                         <span class="n">max_angular_vel</span><span class="p">,</span>
                                         <span class="n">max_angular_acc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Requested end effector name not exists&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.query_joint_limits"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_joint_limits">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_joint_limits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">joint_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query end joint limits from ros param</span>

<span class="sd">        To query the joint limits the ros param definied in</span>
<span class="sd">        joint_limits_param + joint name + limit name is read out</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        join_set : JointSet</span>
<span class="sd">            Set of joints for which the</span>
<span class="sd">            limits are queried</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointLimits</span>
<span class="sd">            Returns a instance of JointLimits</span>
<span class="sd">            invalid limits are of type numpy.nan</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError : type mismatch</span>
<span class="sd">            If joint_set is not of expected type JointSet</span>
<span class="sd">        KeyError</span>
<span class="sd">            If ros params not exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">joint_limits_param</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;robot_description_planning/&#39;</span>
                              <span class="s1">&#39;joint_limits&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">JointSet</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_set is not of expected type JointSet&#39;</span><span class="p">)</span>

        <span class="n">maxVel</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_set</span><span class="p">)</span>
        <span class="n">maxAcc</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_set</span><span class="p">)</span>
        <span class="n">minPos</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_set</span><span class="p">)</span>
        <span class="n">maxPos</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">joint_set</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">joint_limits_param</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

            <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;has_velocity_limits&#39;</span><span class="p">):</span>
                <span class="n">maxVel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;max_velocity&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;has_acceleration_limits&#39;</span><span class="p">):</span>
                <span class="n">maxAcc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;max_acceleration&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;has_position_limits&#39;</span><span class="p">):</span>
                <span class="n">minPos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;min_position&#39;</span><span class="p">)</span>
                <span class="n">maxPos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;max_position&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JointLimits</span><span class="p">(</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">maxVel</span><span class="p">,</span> <span class="n">maxAcc</span><span class="p">,</span> <span class="n">minPos</span><span class="p">,</span> <span class="n">maxPos</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.query_joint_states"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_joint_states">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_joint_states</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">joint_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query joint states by calling the providing ros service</span>

<span class="sd">        To query the joint states the ros service with the name</span>
<span class="sd">        defined in quary_joint_states_service is called</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_set : JointSet</span>
<span class="sd">            Set of joints for which the joint states are queried</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointStates</span>
<span class="sd">            Returns a instance of JointStates which contains the joint</span>
<span class="sd">            states of all joints defined in joint_set</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError : type mismatch</span>
<span class="sd">            If joint_set is not of expected type JointSet</span>
<span class="sd">        xamla_motion.ServiceException</span>
<span class="sd">            If ros service not exists or is not callable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_joint_states_service</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaMoveGroupServices/&#39;</span>
                                      <span class="s1">&#39;query_move_group&#39;</span>
                                      <span class="s1">&#39;_current_position&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">JointSet</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_set is not of expected type JointSet&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_joint_states_service</span><span class="p">,</span>
                <span class="n">GetCurrentJointState</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="n">joint_set</span><span class="o">.</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">current_joint_position</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service call for query current&#39;</span>
                  <span class="s1">&#39;joint states failed, abort &#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; current joint states &#39;</span>
                                   <span class="s1">&#39;failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">r_joint_set</span> <span class="o">=</span> <span class="n">JointSet</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">JointValues</span><span class="p">(</span><span class="n">r_joint_set</span><span class="p">,</span>
                                <span class="n">response</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">velocity</span><span class="p">:</span>
            <span class="n">velocities</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">velocities</span> <span class="o">=</span> <span class="n">JointValues</span><span class="p">(</span><span class="n">r_joint_set</span><span class="p">,</span>
                                     <span class="n">response</span><span class="o">.</span><span class="n">velocity</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">effort</span><span class="p">:</span>
            <span class="n">efforts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">efforts</span> <span class="o">=</span> <span class="n">JointValues</span><span class="p">(</span><span class="n">r_joint_set</span><span class="p">,</span>
                                  <span class="n">response</span><span class="o">.</span><span class="n">effort</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JointStates</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">velocities</span><span class="p">,</span> <span class="n">efforts</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.query_pose"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_pose">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_pose</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move_group_name</span><span class="p">,</span>
                   <span class="n">joint_positions</span><span class="p">,</span> <span class="n">end_effector_link</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the pose by applying forward kinematics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        move_group_name : str convertable</span>
<span class="sd">            name of the move group from which the pose</span>
<span class="sd">            is queried</span>
<span class="sd">        joint_positions : JointValues</span>
<span class="sd">            joint values from which the pose is calculated</span>
<span class="sd">        end_effector_link : str convertable (optional)</span>
<span class="sd">            end effector link is necessary if end effector</span>
<span class="sd">            is not part of the move group but pose should</span>
<span class="sd">            be computed for the end effector</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Pose</span>
<span class="sd">            Pose of the kinematic chain defined by the input parameter</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If joint_positions is not of type JointValues</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_positions</span><span class="p">,</span> <span class="n">JointValues</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_positions is not of&#39;</span>
                            <span class="s1">&#39; expected type JointValues&#39;</span><span class="p">)</span>

        <span class="n">joint_path</span> <span class="o">=</span> <span class="n">JointPath</span><span class="o">.</span><span class="n">from_one_point</span><span class="p">(</span><span class="n">joint_positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_pose_many</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">,</span> <span class="n">joint_path</span><span class="p">,</span>
                                   <span class="n">end_effector_link</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="MotionService.query_pose_many"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_pose_many">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_pose_many</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move_group_name</span><span class="p">,</span>
                        <span class="n">joint_path</span><span class="p">,</span> <span class="n">end_effector_link</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the poses from joint path points by applying forward kinematics</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        move_group_name : str convertable</span>
<span class="sd">            name of the move group from which the poses are queried</span>
<span class="sd">        joint_path : JointPath</span>
<span class="sd">            joint path from which the poses are calculated</span>
<span class="sd">        end_effector_link : str convertable (optional)</span>
<span class="sd">            end effector link is necessary if end effector</span>
<span class="sd">            is not part of the move group but pose should</span>
<span class="sd">            be computed for the end effector</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[Pose]</span>
<span class="sd">            List of Poses</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If joint_path is not of type JointPath</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_forward_kinematics_service</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaMoveGroupServices/&#39;</span>
                                            <span class="s1">&#39;query_fk&#39;</span><span class="p">)</span>

        <span class="n">move_group_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">)</span>
        <span class="n">end_effector_link</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_effector_link</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_path</span><span class="p">,</span> <span class="n">JointPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_path is not of expected type JointPath&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_forward_kinematics_service</span><span class="p">,</span>
                <span class="n">GetFKSolution</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">,</span>
                               <span class="n">end_effector_link</span><span class="p">,</span>
                               <span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span>
                               <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">to_joint_path_point_msg</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">joint_path</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service call for query forward kinematics&#39;</span>
                  <span class="s1">&#39; failed, abort &#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; forward kinematics&#39;</span>
                                   <span class="s1">&#39; failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_codes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">error_msgs</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_codes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_msgs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query forward&#39;</span>
                                   <span class="s1">&#39;kinematics returns with &#39;</span>
                                   <span class="s1">&#39;invalid response&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_codes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">val</span> <span class="o">!=</span> <span class="n">MoveItErrorCodes</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query forward&#39;</span>
                                       <span class="s1">&#39; kinematics was not&#39;</span>
                                       <span class="s1">&#39; successful for point: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span>
                                       <span class="s1">&#39;service name:&#39;</span> <span class="o">+</span>
                                       <span class="n">query_forward_kinematics_service</span> <span class="o">+</span>
                                       <span class="s1">&#39; error code: &#39;</span> <span class="o">+</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_posestamped_msg</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                        <span class="n">response</span><span class="o">.</span><span class="n">solutions</span><span class="p">))</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_query_moveit_joint_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move_group_name</span><span class="p">,</span> <span class="n">joint_path</span><span class="p">):</span>

        <span class="n">query_joint_path_service</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaPlanningServices/&#39;</span>
                                    <span class="s1">&#39;query_joint_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_path</span><span class="p">,</span> <span class="n">JointPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_path is not of expected type JointPath&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_joint_path_service</span><span class="p">,</span>
                <span class="n">GetMoveItJointPath</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">,</span>
                               <span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span>
                               <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">to_joint_path_point_msg</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">joint_path</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service call for query joint path&#39;</span>
                  <span class="s1">&#39; failed, abort &#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; joint path&#39;</span>
                                   <span class="s1">&#39; failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="MotionService.query_collision_free_joint_path"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_collision_free_joint_path">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_collision_free_joint_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move_group_name</span><span class="p">,</span> <span class="n">joint_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query a collision free joint path from a user defined joint path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        move_group_name : str convertable</span>
<span class="sd">            name of the move group for which the collision free joint</span>
<span class="sd">            is required</span>
<span class="sd">        joint_path : JointPath</span>
<span class="sd">            joint path which may contains collisions</span>

<span class="sd">        Results</span>
<span class="sd">        -------</span>
<span class="sd">        JointPath</span>
<span class="sd">            New planned JointPath without collisions</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError : type mismatch</span>
<span class="sd">            If joint_path is not of expectef type JointPath</span>
<span class="sd">            or it move_group_name is not convertable to str</span>

<span class="sd">        ServiceException</span>
<span class="sd">            If query joint path service is not callable or</span>
<span class="sd">            is not successful</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_joint_path_service</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaPlanningServices/&#39;</span>
                                    <span class="s1">&#39;query_joint_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_path</span><span class="p">,</span> <span class="n">JointPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_path is not of expected type JointPath&#39;</span><span class="p">)</span>

        <span class="n">move_group_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_query_moveit_joint_path</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">,</span>
                                                <span class="n">joint_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span> <span class="o">!=</span> <span class="n">MoveItErrorCodes</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query collision free&#39;</span>
                                   <span class="s1">&#39; joint path was not successful. &#39;</span>
                                   <span class="s1">&#39;service name:&#39;</span> <span class="o">+</span>
                                   <span class="n">query_joint_path_service</span> <span class="o">+</span>
                                   <span class="s1">&#39; error code: &#39;</span> <span class="o">+</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">JointPath</span><span class="p">(</span><span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span>
                         <span class="p">[</span><span class="n">JointValues</span><span class="p">(</span><span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">path</span><span class="p">])</span></div>

<div class="viewcode-block" id="MotionService.query_joint_trajectory"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_joint_trajectory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_joint_trajectory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">joint_path</span><span class="p">,</span> <span class="n">max_velocity</span><span class="p">,</span> <span class="n">max_acceleration</span><span class="p">,</span>
                               <span class="n">max_deviation</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query a joint trajectory from joint path / joint positions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_path : JointPath</span>
<span class="sd">            Defines the key joint positions the trajectory must reach</span>
<span class="sd">        max_velocity : Iterable[float convertable]</span>
<span class="sd">            Defines the maximal velocity for every joint</span>
<span class="sd">        max_acceleration : Iterable[float convertable]</span>
<span class="sd">            Defines the maximal acceleration for every joint</span>
<span class="sd">        max_deviation : float convertable</span>
<span class="sd">            Defines the maximal deviation of the joints to the</span>
<span class="sd">            defined key points while executing the trajectory</span>
<span class="sd">        delta_t : float convertable</span>
<span class="sd">            Sampling points frequency or time</span>
<span class="sd">            if value is create as 1.0 the value is interpreted</span>
<span class="sd">            as a value in seconds else the value is interpreted</span>
<span class="sd">            as a value in Hz</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointTrajectory</span>
<span class="sd">            An instance of JointTrajectory with dense JointTrajectoryPoints</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If joint_path is not of expected type JointPath or</span>
<span class="sd">            max_velocity or max_acceleration is not iterable or</span>
<span class="sd">            values of max_velocity, max_acceleration or delta_t</span>
<span class="sd">            are not convertable to float</span>
<span class="sd">        ValueError</span>
<span class="sd">            If max_velocity or max_acceleration have not the same</span>
<span class="sd">            number of values has joints are defined in joint_path</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_joint_trajectory_service</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaPlanningServices/&#39;</span>
                                          <span class="s1">&#39;query_joint_trajectory&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_path</span><span class="p">,</span> <span class="n">JointPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_path is not of expected type JointPath&#39;</span><span class="p">)</span>

        <span class="n">max_velocity</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">max_velocity</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">max_velocity</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_velocity has not the same number of values&#39;</span>
                             <span class="s1">&#39; as joints are defined in joint_path&#39;</span><span class="p">)</span>

        <span class="n">max_acceleration</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">max_acceleration</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">max_acceleration</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_acceleration has not the same number of&#39;</span>
                             <span class="s1">&#39; values as joints are defined in joint_path&#39;</span><span class="p">)</span>

        <span class="n">max_deviation</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_deviation</span><span class="p">)</span>
        <span class="n">delta_t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">delta_t</span><span class="p">)</span>

        <span class="n">delta_t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">delta_t</span> <span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">delta_t</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_joint_trajectory_service</span><span class="p">,</span>
                <span class="n">GetOptimJointTrajectory</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span>
                               <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">to_joint_path_point_msg</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">joint_path</span><span class="p">],</span>
                               <span class="n">max_velocity</span><span class="p">,</span>
                               <span class="n">max_acceleration</span><span class="p">,</span>
                               <span class="n">max_deviation</span><span class="p">,</span>
                               <span class="n">delta_t</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service call for query joint trajectory&#39;</span>
                  <span class="s1">&#39; failed, abort &#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; joint trajectory&#39;</span>
                                   <span class="s1">&#39; failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span> <span class="o">!=</span> <span class="n">MoveItErrorCodes</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query joint&#39;</span>
                                   <span class="s1">&#39; trajectory was not successful. &#39;</span>
                                   <span class="s1">&#39;service name:&#39;</span> <span class="o">+</span>
                                   <span class="n">query_joint_trajectory_service</span> <span class="o">+</span>
                                   <span class="s1">&#39; error code: &#39;</span> <span class="o">+</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>

        <span class="n">j</span> <span class="o">=</span> <span class="n">JointSet</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">JointTrajectoryPoint</span><span class="o">.</span><span class="n">from_joint_trajectory_point_msg</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">JointTrajectory</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.query_task_space_trajectory"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_task_space_trajectory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_task_space_trajectory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">end_effector_name</span><span class="p">,</span> <span class="n">cartesian_path</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span>
                                    <span class="n">max_xyz_velocity</span><span class="p">,</span> <span class="n">max_xyz_acceleration</span><span class="p">,</span>
                                    <span class="n">max_angular_velocity</span><span class="p">,</span> <span class="n">max_angular_acceleration</span><span class="p">,</span>
                                    <span class="n">ik_jump_threshold</span><span class="p">,</span> <span class="n">max_deviation</span><span class="p">,</span> <span class="n">collision_check</span><span class="p">,</span>
                                    <span class="n">delta_t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query a joint trajectory from task space poses</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        end_effector_name : str convertable</span>
<span class="sd">            Name of the end effector for a trajectory should be quried</span>
<span class="sd">        cartesian_path : CartesianPath</span>
<span class="sd">            Define the key poses the trajectory must reach</span>
<span class="sd">        seed : JointValues</span>
<span class="sd">            numerical seed to control configuration of the robot</span>
<span class="sd">        max_xyz_velocity : float convertable</span>
<span class="sd">            max velocity for translation in m/s</span>
<span class="sd">        max_xyz_acceleration : float convertable</span>
<span class="sd">            max acceleration for translation in m/s^2</span>
<span class="sd">        max_angular_velocity : float convertable</span>
<span class="sd">            max angular velocity in rad/s</span>
<span class="sd">        max_angular_acceleration : float convertable</span>
<span class="sd">            max angular acceleration in rad/s^2</span>
<span class="sd">        ik_jump_threshold : float convertable</span>
<span class="sd">            maximal inverse kinematic jump</span>
<span class="sd">        max_deviation : float convertable</span>
<span class="sd">            Defines the maximal deviation of the joints to the</span>
<span class="sd">            defined key points while executing the trajectory</span>
<span class="sd">        collision_check : bool convertable</span>
<span class="sd">            If true check the trajectory is collision free</span>
<span class="sd">        delta_t : float convertable</span>
<span class="sd">             Sampling points frequency or time</span>
<span class="sd">            if value is create as 1.0 the value is interpreted</span>
<span class="sd">            as a value in seconds else the value is interpreted</span>
<span class="sd">            as a value in Hz</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointTrajectory</span>
<span class="sd">            An instance of JointTrajectory with dense JointTrajectoryPoints</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If cartesian_path is not of expected type CartesianPath or</span>
<span class="sd">            if seed is not of expected type JointValues</span>
<span class="sd">            max_* is not iterable or the values are not convertable</span>
<span class="sd">            as expected</span>
<span class="sd">        ValueError</span>
<span class="sd">            If max_velocity or max_acceleration have not the same</span>
<span class="sd">            number of values has joints are defined in joint_path</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_cartesian_trajectory_service</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaPlanningServices/&#39;</span>
                                              <span class="s1">&#39;query_cartesian_trajectory&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cartesian_path</span><span class="p">,</span> <span class="n">CartesianPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;cartesian_path is not of expected type CartesianPath&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">JointValues</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;seed is not of expected type JointValues&#39;</span><span class="p">)</span>

        <span class="n">max_xyz_velocity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_xyz_velocity</span><span class="p">)</span>

        <span class="n">max_xyz_acceleration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_xyz_acceleration</span><span class="p">)</span>

        <span class="n">max_angular_velocity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_angular_velocity</span><span class="p">)</span>

        <span class="n">max_angular_acceleration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_angular_acceleration</span><span class="p">)</span>

        <span class="n">end_effector_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_effector_name</span><span class="p">)</span>
        <span class="n">ik_jump_threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ik_jump_threshold</span><span class="p">)</span>
        <span class="n">max_deviation</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_deviation</span><span class="p">)</span>
        <span class="n">collision_check</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">collision_check</span><span class="p">)</span>

        <span class="n">delta_t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">delta_t</span><span class="p">)</span>

        <span class="n">delta_t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">delta_t</span> <span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">delta_t</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_cartesian_trajectory_service</span><span class="p">,</span>
                <span class="n">GetLinearCartesianTrajectory</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="n">end_effector_name</span><span class="p">,</span>
                               <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">to_posestamped_msg</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cartesian_path</span><span class="p">],</span>
                               <span class="n">max_xyz_velocity</span><span class="p">,</span>
                               <span class="n">max_xyz_acceleration</span><span class="p">,</span>
                               <span class="n">max_angular_velocity</span><span class="p">,</span>
                               <span class="n">max_angular_acceleration</span><span class="p">,</span>
                               <span class="n">delta_t</span><span class="p">,</span>
                               <span class="n">ik_jump_threshold</span><span class="p">,</span>
                               <span class="n">max_deviation</span><span class="p">,</span>
                               <span class="n">seed</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span>
                               <span class="n">seed</span><span class="o">.</span><span class="n">to_joint_path_point_msg</span><span class="p">(),</span>
                               <span class="n">collision_check</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service call for query cartesian trajectory&#39;</span>
                  <span class="s1">&#39; failed, abort &#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; cartesian trajectory&#39;</span>
                                   <span class="s1">&#39; failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span> <span class="o">!=</span> <span class="n">MoveItErrorCodes</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query cartesian&#39;</span>
                                   <span class="s1">&#39; trajectory was not successful. &#39;</span>
                                   <span class="s1">&#39;service name:&#39;</span> <span class="o">+</span>
                                   <span class="n">query_cartesian_trajectory_service</span> <span class="o">+</span>
                                   <span class="s1">&#39; error code: &#39;</span> <span class="o">+</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>

        <span class="n">j</span> <span class="o">=</span> <span class="n">JointSet</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">JointTrajectoryPoint</span><span class="o">.</span><span class="n">from_joint_trajectory_point_msg</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">JointTrajectory</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.query_joint_path_collisions"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_joint_path_collisions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">query_joint_path_collisions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move_group_name</span><span class="p">,</span> <span class="n">joint_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query collisions in joint path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        move_group_name : str convertable</span>
<span class="sd">            Name of the move group for which a path should be check</span>
<span class="sd">            for collisions</span>
<span class="sd">        joint_path : JointPath</span>
<span class="sd">            The path that should be check for collisions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[JointValuesCollision] or None</span>
<span class="sd">            If collisions exists returns a list of</span>
<span class="sd">            JointValuesCollisions else returns None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If move_group_name ist not str convertable or</span>
<span class="sd">            if joint_path is not of type JointPath</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_joint_path_collisions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;xamlaMoveGroupServices/&#39;</span>
                                       <span class="s1">&#39;query_joint_position_collision_check&#39;</span><span class="p">)</span>

        <span class="n">move_group_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint_path</span><span class="p">,</span> <span class="n">JointPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;joint_path is not of expected type JointPath&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_joint_path_collisions</span><span class="p">,</span>
                <span class="n">QueryJointStateCollisions</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">,</span>
                               <span class="n">joint_path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span>
                               <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">to_joint_path_point_msg</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">joint_path</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service call for query joint collisions&#39;</span>
                  <span class="s1">&#39; failed, abort &#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; joint collisions&#39;</span>
                                   <span class="s1">&#39; failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">response</span><span class="o">.</span><span class="n">in_collision</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">in_collision</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">error_codes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_codes</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">in_collision</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_path</span><span class="p">)</span> <span class="ow">or</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_codes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_path</span><span class="p">)</span> <span class="ow">or</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_path</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query joint&#39;</span>
                                   <span class="s1">&#39; collisions was not successful. &#39;</span>
                                   <span class="s1">&#39;service name:&#39;</span> <span class="o">+</span>
                                   <span class="n">query_joint_path_collisions</span> <span class="o">+</span>
                                   <span class="s1">&#39; error code: &#39;</span> <span class="o">+</span>
                                   <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">JointValuesCollisions</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">error_codes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">response</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_path</span><span class="p">))</span>
                  <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">in_collision</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="MotionService.create_plan_parameters"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.create_plan_parameters">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_plan_parameters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move_group_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">joint_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">max_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_acceleration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create PlanParameters from user defined and/or quried inputs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        move_group_name : str (optional  default query first)</span>
<span class="sd">            move group for which plan parameters should be created</span>
<span class="sd">        joint_set : JointSet (optional default query similar)</span>
<span class="sd">            joint set for which plan parameters should be created</span>
<span class="sd">        max_velocity : Iterable[float convertable] (optional default max query)</span>
<span class="sd">            Defines the maximal velocity for every joint</span>
<span class="sd">        max_acceleration : Iterable[float convertable] (op default max query)</span>
<span class="sd">            Defines the maximal acceleration for every joint</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            sample_resolution : float convertable (optional default 0.008/125Hz)</span>
<span class="sd">                sample points frequency</span>
<span class="sd">                if value is create as 1.0 the value is interpreted</span>
<span class="sd">                as a value in seconds else the value is interpreted</span>
<span class="sd">                as a value in Hz</span>
<span class="sd">            collision_check : bool convertable (optional default True)</span>
<span class="sd">                check for collision if True</span>
<span class="sd">            max_deviation : float convertable (optional default 0.2)</span>
<span class="sd">                max deviation from fly by points</span>
<span class="sd">            velocity_scaling : float convertable (optional default 1.0)</span>
<span class="sd">                scale query or user defined max velocity</span>
<span class="sd">                values between 0.0 and 1.0</span>
<span class="sd">            acceleration_scaling : float convertable (optional default 1.0)</span>
<span class="sd">                scale query or user defined max acceleration</span>
<span class="sd">                values between 0.0 and 1.0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PlanParameters</span>
<span class="sd">            Instance of plan parameters with automatically</span>
<span class="sd">            queried and/or user defined values</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query services are not reachable or</span>
<span class="sd">            not finish successful</span>
<span class="sd">        TypeError</span>
<span class="sd">            If move group name is not of type None or str convertable</span>
<span class="sd">            If joint_set is not of type None or JointSet</span>
<span class="sd">            If an other parameter is not convertable</span>
<span class="sd">        ValueError</span>
<span class="sd">            If scaling parameters are not between 0.0 and 1.0</span>
<span class="sd">        ArgumentError</span>
<span class="sd">            If a argument is not set and also could not be</span>
<span class="sd">            quired automatically</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">move_group_name</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_available_move_groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">joint_set</span> <span class="o">=</span> <span class="n">joint_set</span> <span class="k">if</span> <span class="n">joint_set</span> <span class="k">else</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">joint_set</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">joint_set</span><span class="o">.</span><span class="n">is_similar</span><span class="p">(</span><span class="n">joint_set</span><span class="p">):</span>
                        <span class="n">move_group_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ArgumentError</span><span class="p">(</span><span class="s1">&#39;no move group name was provided and&#39;</span>
                                    <span class="s1">&#39; also no move group could&#39;</span>
                                    <span class="s1">&#39; automatically be quired&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">joint_set</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_available_move_groups</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">move_group_name</span><span class="p">:</span>
                    <span class="n">joint_set</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">joint_set</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">joint_set</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ArgumentError</span><span class="p">(</span><span class="s1">&#39;no joint_set was provided and&#39;</span>
                                    <span class="s1">&#39; also no joint_set could&#39;</span>
                                    <span class="s1">&#39; automatically be quired&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_velocity</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">max_acceleration</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_joint_limits</span><span class="p">(</span><span class="n">joint_set</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_velocity</span><span class="p">:</span>
                <span class="n">max_velocity</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">max_velocity</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_acceleration</span><span class="p">:</span>
                <span class="n">max_acceleration</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">max_acceleration</span>

        <span class="n">joint_limits</span> <span class="o">=</span> <span class="n">JointLimits</span><span class="p">(</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">max_velocity</span><span class="p">,</span>
                                   <span class="n">max_acceleration</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PlanParameters</span><span class="p">(</span><span class="n">move_group_name</span><span class="p">,</span> <span class="n">joint_limits</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.create_task_space_plan_parameters"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.create_task_space_plan_parameters">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_task_space_plan_parameters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">end_effector_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">max_xyz_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">max_xyz_acceleration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">max_angular_velocity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">max_angular_acceleration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates TakesSpacePlanParameters from user defined or queried inputs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        move_group_name : str (optional default query first)</span>
<span class="sd">            move group for which plan parameters should be created</span>
<span class="sd">        max_xyz_velocity : float convertable or None</span>
<span class="sd">            Defines the maximal xyz velocity [m/s]</span>
<span class="sd">        max_xyz_acceleration : float convertable</span>
<span class="sd">            Defines the maximal xyz acceleration [m/s^2]</span>
<span class="sd">        max_angular_velocity : float convertable or None</span>
<span class="sd">            Defines the maximal angular velocity [rad/s]</span>
<span class="sd">        max_angular_acceleration : float convertable or None</span>
<span class="sd">            Defines the maximal angular acceleration [rad/s^2]</span>
<span class="sd">        kwargs : dict</span>
<span class="sd">            sample_resolution : float convertable (optional default 0.008/125Hz)</span>
<span class="sd">                sample points frequency</span>
<span class="sd">                if value is create as 1.0 the value is interpreted</span>
<span class="sd">                as a value in seconds else the value is interpreted</span>
<span class="sd">                as a value in Hz</span>
<span class="sd">            collision_check : bool convertable (optional default True)</span>
<span class="sd">                check for collision if True</span>
<span class="sd">            ik_jump_threshold : float convertable (optional default 1.2)</span>
<span class="sd">                maximal inverse kinematic jump</span>
<span class="sd">            max_deviation : float convertable (optional default 0.2)</span>
<span class="sd">                max deviation from fly by points</span>
<span class="sd">            velocity_scaling : float convertable (optional default 1.0)</span>
<span class="sd">                scale query or user defined max velocity</span>
<span class="sd">                values between 0.0 and 1.0</span>
<span class="sd">            acceleration_scaling : float convertable (optional default 1.0)</span>
<span class="sd">                scale query or user defined max acceleration</span>
<span class="sd">                values between 0.0 and 1.0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TaskSpacePlanParameters</span>
<span class="sd">            Instance of TaskSpacePlanParameters with automatically</span>
<span class="sd">            queried and/or user defined values</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query services are not reachable or</span>
<span class="sd">            not finish successful</span>
<span class="sd">        TypeError</span>
<span class="sd">            If end_effector_name is not of type None or str convertable</span>
<span class="sd">            If an other parameter is not convertable</span>
<span class="sd">        ValueError</span>
<span class="sd">            If scaling parameters are not between 0.0 and 1.0</span>
<span class="sd">        ArgumentError</span>
<span class="sd">            If a argument is not set and also could not be</span>
<span class="sd">            quired automatically</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">end_effector_name</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_available_move_groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">end_effector_link_names</span><span class="p">:</span>
                        <span class="n">end_effector_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">end_effector_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">end_effector_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ArgumentError</span><span class="p">(</span><span class="s1">&#39;no end effector name was provided and&#39;</span>
                                    <span class="s1">&#39; also end effector name could&#39;</span>
                                    <span class="s1">&#39; automatically be quired&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">max_xyz_velocity</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">max_xyz_acceleration</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">max_angular_velocity</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">max_angular_acceleration</span><span class="p">):</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_endeffector_limits</span><span class="p">(</span><span class="n">end_effector_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_xyz_velocity</span><span class="p">:</span>
                <span class="n">max_xyz_velocity</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">max_xyz_velocity</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_xyz_acceleration</span><span class="p">:</span>
                <span class="n">max_xyz_acceleration</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">max_xyz_acceleration</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_angular_velocity</span><span class="p">:</span>
                <span class="n">max_angular_velocity</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">max_angular_velocity</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_angular_acceleration</span><span class="p">:</span>
                <span class="n">max_angular_acceleration</span> <span class="o">=</span> <span class="n">limits</span><span class="o">.</span><span class="n">max_angular_acceleration</span>

        <span class="n">end_effector_limits</span> <span class="o">=</span> <span class="n">EndEffectorLimits</span><span class="p">(</span><span class="n">max_xyz_velocity</span><span class="p">,</span>
                                                <span class="n">max_xyz_acceleration</span><span class="p">,</span>
                                                <span class="n">max_angular_velocity</span><span class="p">,</span>
                                                <span class="n">max_angular_acceleration</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TaskSpacePlanParameters</span><span class="p">(</span><span class="n">end_effector_name</span><span class="p">,</span>
                                       <span class="n">end_effector_limits</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.plan_collision_free_joint_path"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.plan_collision_free_joint_path">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">plan_collision_free_joint_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plans a collision free joint path by query it</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : JointPath</span>
<span class="sd">            joint path which should be replanned to be</span>
<span class="sd">            collision free</span>
<span class="sd">        parameters : PlanParameters</span>
<span class="sd">            plan parameters which defines the limits and</span>
<span class="sd">            move group</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointPath</span>
<span class="sd">            the replanned collision free joint path</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If path is not of type JointPath or</span>
<span class="sd">            if parameters is not of type PlanParameters</span>
<span class="sd">        ValueError</span>
<span class="sd">            If parameters joint set is not equal or sub</span>
<span class="sd">            set of the path joint set and therefore</span>
<span class="sd">            reordering was not possible</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query service is not available or finish</span>
<span class="sd">            unsuccessfully</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">JointPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;path is not of expected&#39;</span>
                            <span class="s1">&#39; type JointPath&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">PlanParameters</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;parameters is not of expected&#39;</span>
                            <span class="s1">&#39; type PlanParameters&#39;</span><span class="p">)</span>

        <span class="c1"># reorder path in respect to plan parameter joint_set</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">JointPath</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_collision_free_joint_path</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">move_group_name</span><span class="p">,</span>
                                                   <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.plan_move_pose_linear"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.plan_move_pose_linear">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">plan_move_pose_linear</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plans trajectory with linear movements from a cartesian path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : CartesianPath</span>
<span class="sd">            cartesian path with poses the trajectory must reach</span>
<span class="sd">        seed : JointValues</span>
<span class="sd">            numerical seed to control configuration</span>
<span class="sd">        parameters : TaskSpacePlanParameters</span>
<span class="sd">            plan parameters which defines the limits, settings</span>
<span class="sd">            and end effector name</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointTrajectory</span>
<span class="sd">            Planned joint trajectory which reach the poses</span>
<span class="sd">            defined in path under the constraints of</span>
<span class="sd">            parameters</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If path is not of type CartesianPath or</span>
<span class="sd">            if parameters is not of type TaskSpacePlanParameters or</span>
<span class="sd">            if seed is not of type JointValues</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query service is not available or finish</span>
<span class="sd">            unsuccessfully</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">CartesianPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;path is not of expected type CartesianPath&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">JointValues</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;seed is not of expected type JointValues&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">TaskSpacePlanParameters</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;parameters is not of expected type&#39;</span>
                            <span class="s1">&#39; TaskSpacePlanParameters&#39;</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_task_space_trajectory</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">end_effector_name</span><span class="p">,</span>
                                               <span class="n">path</span><span class="p">,</span>
                                               <span class="n">seed</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">max_xyz_velocity</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">max_xyz_acceleration</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">max_angular_velocity</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">max_angular_acceleration</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">ik_jump_threshold</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">max_deviation</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">collision_check</span><span class="p">,</span>
                                               <span class="n">p</span><span class="o">.</span><span class="n">sample_resolution</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.plan_move_joints"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.plan_move_joints">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">plan_move_joints</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plans trajectory from a joint path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : JointPath</span>
<span class="sd">            joint path with positions the trajectory must reach</span>
<span class="sd">        parameters : PlanParameters</span>
<span class="sd">            plan parameters which defines the limits, settings</span>
<span class="sd">            and move group name</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointTrajectory</span>
<span class="sd">            Planned joint trajectory which reach the positions</span>
<span class="sd">            defined in path under the constraints of</span>
<span class="sd">            parameters</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If path is not of type JointPath or</span>
<span class="sd">            if parameters is not of type PlanParameters or</span>
<span class="sd">        ValueError</span>
<span class="sd">            If parameters joint set is not equal or sub</span>
<span class="sd">            set of the path joint set and therefore</span>
<span class="sd">            reordering was not possible</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query service is not available or finish</span>
<span class="sd">            unsuccessfully</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">JointPath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;path is not of expected type JointPath&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">PlanParameters</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;parameters is not of expected type&#39;</span>
                            <span class="s1">&#39; PlanParameters&#39;</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">JointPath</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

        <span class="n">max_velocity</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">max_velocity</span>
        <span class="n">max_acc</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">max_acceleration</span>

        <span class="n">vel_isnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_velocity</span><span class="p">)</span>
        <span class="n">acc_isnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_acceleration</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">vel_isnan</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">acc_isnan</span><span class="p">):</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_joint_limits</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">joint_set</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">vel_isnan</span><span class="p">):</span>
                <span class="n">max_velocity</span> <span class="o">=</span> <span class="p">[</span><span class="n">limits</span><span class="o">.</span><span class="n">max_velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>
                                <span class="n">parameters</span><span class="o">.</span><span class="n">velocity_scaling</span>
                                <span class="k">if</span> <span class="n">vel_isnan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">l</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_velocity</span><span class="p">)]</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">acc_isnan</span><span class="p">):</span>
                <span class="n">max_acc</span> <span class="o">=</span> <span class="p">[</span><span class="n">limits</span><span class="o">.</span><span class="n">max_acceleration</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>
                           <span class="n">parameters</span><span class="o">.</span><span class="n">acceleration_scaling</span>
                           <span class="k">if</span> <span class="n">acc_isnan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">l</span>
                           <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_acceleration</span><span class="p">)]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_joint_trajectory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                          <span class="n">max_velocity</span><span class="p">,</span>
                                          <span class="n">max_acc</span><span class="p">,</span>
                                          <span class="n">parameters</span><span class="o">.</span><span class="n">max_deviation</span><span class="p">,</span>
                                          <span class="n">parameters</span><span class="o">.</span><span class="n">sample_resolution</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.execute_joint_trajectory"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.execute_joint_trajectory">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute_joint_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">collision_check</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a joint trajectory</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trajectory : JointTrajectory</span>
<span class="sd">            Joint trajectory which should be executed</span>
<span class="sd">        collision_check : bool convertable</span>
<span class="sd">            If True check for collision while executing</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If trajectory is not of type JointTrajectory</span>
<span class="sd">            or if collision_check is not convertable to bool</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If execution ends not successful</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">JointTrajectory</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;trajectory is not of expected type&#39;</span>
                            <span class="s1">&#39; joint trajectory&#39;</span><span class="p">)</span>

        <span class="n">collision_check</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">collision_check</span><span class="p">)</span>

        <span class="n">goal</span> <span class="o">=</span> <span class="n">moveJGoal</span><span class="p">(</span><span class="n">trajectory</span><span class="o">=</span><span class="n">trajectory</span><span class="o">.</span><span class="n">to_joint_trajectory_msg</span><span class="p">(),</span>
                         <span class="n">check_collision</span><span class="o">=</span><span class="n">collision_check</span><span class="p">)</span>

        <span class="n">run_action</span> <span class="o">=</span> <span class="n">generate_action_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__m_action</span><span class="p">)</span>

        <span class="c1"># the server itself lock resources</span>
        <span class="c1"># with LeaseBaseLock(trajectory.joint_set.names) as lock_resources:</span>
        <span class="k">await</span> <span class="n">run_action</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.execute_joint_trajectory_supervised"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.execute_joint_trajectory_supervised">[docs]</a>    <span class="k">def</span> <span class="nf">execute_joint_trajectory_supervised</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">:</span> <span class="n">JointTrajectory</span><span class="p">,</span>
                                            <span class="n">velocity_scaling</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                            <span class="n">collision_check</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SteppedMotionClient</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a instance of SteppedMotionClient for supervised trajectory execution</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trajectory : JointTrajectory</span>
<span class="sd">            Joint trajectory which should be executed</span>
<span class="sd">        velocity_scaling : float</span>
<span class="sd">            scaling of velocity range 0.0 to 1.0</span>
<span class="sd">        collision_check : bool convertable</span>
<span class="sd">            If True check for collision while executing</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : int</span>
<span class="sd">            Result of the trajectory execution</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If trajectory is not of type JointTrajectory</span>
<span class="sd">            or if collision_check is not convertable to bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">SteppedMotionClient</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">velocity_scaling</span><span class="p">,</span> <span class="n">collision_check</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.query_inverse_kinematics"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_inverse_kinematics">[docs]</a>    <span class="k">def</span> <span class="nf">query_inverse_kinematics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span>
                                 <span class="n">seed</span><span class="o">=</span><span class="p">[],</span>
                                 <span class="n">end_effector_link</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">attempts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">const_seed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query inverse kinematic solutions one pose</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pose : pose</span>
<span class="sd">            Pose to transform to joint space</span>
<span class="sd">        parameters : PlanParameters</span>
<span class="sd">            Plan parameters which defines the limits, settings</span>
<span class="sd">            and move group name</span>
<span class="sd">        seed : JointValues (optional)</span>
<span class="sd">            Numerical seed to control joint configuration</span>
<span class="sd">        end_effector_link : str convertable (optinal)</span>
<span class="sd">            necessary if poses are defined for end effector link</span>
<span class="sd">        timeout : datatime.timedelta (optional)</span>
<span class="sd">            timeout</span>
<span class="sd">        attempts : int convertable (optional default 1)</span>
<span class="sd">            Attempts to find a solution or each pose</span>
<span class="sd">        const_seed : bool convertable (optional default False)</span>
<span class="sd">            use constant seed instead of consecutive seeds</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointValues</span>
<span class="sd">            Instance of JointValues which is the joint space</span>
<span class="sd">            equivalent of the task space pose</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If pose is not of type Pose or</span>
<span class="sd">            parameters is not of type PlanParameters</span>
<span class="sd">            or seed is not empty list or type JointValues</span>
<span class="sd">            or the other parameters are not convertable</span>
<span class="sd">            to defined types</span>
<span class="sd">        ValueError</span>
<span class="sd">            If parameters joint set is not equal or sub</span>
<span class="sd">            set of the seed joint set if defined and therefore</span>
<span class="sd">            reordering was not possible</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query service is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">Pose</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;pose is not of expected type Pose&#39;</span><span class="p">)</span>

        <span class="n">end_effector_pose</span> <span class="o">=</span> <span class="n">EndEffectorPose</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">end_effector_link</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_inverse_kinematics_many</span><span class="p">([</span><span class="n">end_effector_pose</span><span class="p">],</span>
                                                    <span class="n">parameters</span><span class="p">,</span>
                                                    <span class="n">seed</span><span class="p">,</span>
                                                    <span class="n">timeout</span><span class="p">,</span>
                                                    <span class="n">attempts</span><span class="p">,</span>
                                                    <span class="n">const_seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">succeeded</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;ik service call failed with error&#39;</span>
                                   <span class="s1">&#39; code: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="MotionService.query_inverse_kinematics_many"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.query_inverse_kinematics_many">[docs]</a>    <span class="k">def</span> <span class="nf">query_inverse_kinematics_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poses</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span>
                                      <span class="n">seed</span><span class="o">=</span><span class="p">[],</span>
                                      <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">attempts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">const_seed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query inverse kinematic solutions for a Iterable of Poses</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        poses : Iterable[EndEffectorPose]</span>
<span class="sd">            Iterable with EndEffectorPoses to transform to joint space</span>
<span class="sd">        parameters : PlanParameters</span>
<span class="sd">            Plan parameters which defines the limits, settings</span>
<span class="sd">            and move group name</span>
<span class="sd">        seed : JointValues (optional)</span>
<span class="sd">            Numerical seed to control joint configuration</span>
<span class="sd">        timeout : datatime.timedelta</span>
<span class="sd">            timeout</span>
<span class="sd">        attempts : int convertable (optional default 1)</span>
<span class="sd">            attempts to find a solution for each pose</span>
<span class="sd">        const_seed : bool convertable (optional default False)</span>
<span class="sd">            use constant seed instead of consecutive seeds</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        IkResult</span>
<span class="sd">            Instance of IkResult with all found solutions as</span>
<span class="sd">            a JointPath and error codes</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If poses is not of type EndEffectorPose or</span>
<span class="sd">            parameters is not of type PlanParameters</span>
<span class="sd">            or seed is not empty list or type JointValues</span>
<span class="sd">            or the other parameters are not convertable</span>
<span class="sd">            to defined types</span>
<span class="sd">        ValueError</span>
<span class="sd">            If parameters joint set is not equal or sub</span>
<span class="sd">            set of the seed joint set if defined and therefore</span>
<span class="sd">            reordering was not possible</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query service is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">poses</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">EndEffectorPose</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poses</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;poses is not of expected type Iterable[EndEffectorPose]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">PlanParameters</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;parameters is not of expected&#39;</span>
                            <span class="s1">&#39; type PlanParameters&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seed</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">JointValues</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;seed is not of expected&#39;</span>
                                <span class="s1">&#39; type JointValues&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">seed</span><span class="o">.</span><span class="n">joint_set</span> <span class="o">==</span> <span class="n">parameters</span><span class="o">.</span><span class="n">joint_set</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">parameters</span><span class="o">.</span><span class="n">joint_set</span><span class="o">.</span><span class="n">is_subset</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">joint_set</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;joint set of parameters and seed do not&#39;</span>
                                 <span class="s1">&#39; match and reording is not possible&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;timeout is not of expected type timedelta&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">attempts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span>
        <span class="n">const_seed</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">const_seed</span><span class="p">)</span>

        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ros_duration_from_timedelta</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

        <span class="n">poses_msgs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poses</span><span class="p">:</span>
            <span class="n">poses_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">to_end_effector_pose_msg</span><span class="p">())</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">GetIKSolution2Request</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">group_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">move_group_name</span>
        <span class="n">req</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">joint_set</span><span class="o">.</span><span class="n">names</span>
        <span class="n">req</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">to_joint_values_point_msg</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">const_seed</span> <span class="o">=</span> <span class="n">const_seed</span>
        <span class="n">req</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">poses_msgs</span>
        <span class="n">req</span><span class="o">.</span><span class="n">collision_check</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">collision_check</span>
        <span class="n">req</span><span class="o">.</span><span class="n">attempts</span> <span class="o">=</span> <span class="n">attempts</span>
        <span class="n">req</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">duration</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ik_service</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service call for query inverse kinematics&#39;</span>
                  <span class="s1">&#39; failed, abort &#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query&#39;</span>
                                   <span class="s1">&#39; inverse kinematics&#39;</span>
                                   <span class="s1">&#39; failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">JointValues</span><span class="o">.</span><span class="n">from_joint_path_point_msg</span>
        <span class="n">joint_path</span> <span class="o">=</span> <span class="n">JointPath</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span>
                               <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">joint_set</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">joint_set</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">solutions</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">IkResults</span><span class="p">(</span><span class="n">joint_path</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">error_codes</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_ros_duration_from_timedelta</span><span class="p">(</span><span class="n">timedelta</span><span class="p">):</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="o">+</span><span class="n">timedelta</span><span class="o">.</span><span class="n">seconds</span>
        <span class="n">nsecs</span> <span class="o">=</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">microseconds</span><span class="o">*</span><span class="mi">1000</span>
        <span class="k">return</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="n">nsecs</span><span class="p">)</span>

<div class="viewcode-block" id="MotionService.plan_cartesian_path"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.plan_cartesian_path">[docs]</a>    <span class="k">def</span> <span class="nf">plan_cartesian_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plan a joint trajectory from a cartesian path and plan parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : CartesianPath</span>
<span class="sd">            Poses the planned trajectory must reach</span>
<span class="sd">        parameters : PlanParameters</span>
<span class="sd">            Plan parameters which defines the limits, settings</span>
<span class="sd">            and move group name</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JointTrajectory</span>
<span class="sd">            A joint trajectory which reach defined poses of path</span>
<span class="sd">            under the constrains in parameters</span>


<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If path is not of type CartesianPath or</span>
<span class="sd">            parameters is not of type PlanParameters</span>
<span class="sd">        ValueError</span>
<span class="sd">            If parameters joint set is not equal or sub</span>
<span class="sd">            set of the seed joint set and therefore</span>
<span class="sd">            reordering was not possible</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query services are not available or</span>
<span class="sd">            finish unsuccessfully or inverse kinematics</span>
<span class="sd">            ends with error</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_joint_states</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">joint_set</span><span class="p">)</span><span class="o">.</span><span class="n">positions</span>
        <span class="n">poses</span> <span class="o">=</span> <span class="p">[</span><span class="n">EndEffectorPose</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_inverse_kinematics_many</span><span class="p">(</span><span class="n">poses</span><span class="p">,</span>
                                                    <span class="n">parameters</span><span class="p">,</span>
                                                    <span class="n">seed</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">succeeded</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for query inverse&#39;</span>
                                   <span class="s1">&#39; kinematics was not successful&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_collision_free_joint_path</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                                   <span class="n">parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="MotionService.emergency_stop"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.emergency_stop">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">emergency_stop</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets and resets emergency stop</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        enable : bool convertable (default True)</span>
<span class="sd">            If True activate emergency stop</span>
<span class="sd">            If False resets the emergency stop</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        success : bool</span>
<span class="sd">            True if the service call was successful</span>
<span class="sd">        message : str</span>
<span class="sd">            Response or error message</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If enable is not convertable to bool</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If query service is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query_emergency_stop</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EmergencySTOP/&#39;</span>
                                <span class="s1">&#39;query_emergency_stop&#39;</span><span class="p">)</span>

        <span class="n">enable</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="n">query_emergency_stop</span><span class="p">,</span>
                <span class="n">SetBool</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">service</span><span class="p">(</span><span class="n">enable</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;service set emergency stop failed&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;service call for set emergency&#39;</span>
                                   <span class="s1">&#39; stop failed, abort&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">success</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span></div>

<div class="viewcode-block" id="MotionService.get_current_joint_values"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.get_current_joint_values">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_current_joint_values</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">joint_set</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the current joint positions of all joints in joint_set</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_set : JointSet</span>
<span class="sd">            Defines for which joint the positions are requested</span>

<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        positions : JointValues</span>
<span class="sd">            Returns a instance of JointValues with the positions</span>
<span class="sd">            of the requested joint set</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If joint_set is not of type JointSet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query_joint_states</span><span class="p">(</span><span class="n">joint_set</span><span class="p">)</span><span class="o">.</span><span class="n">positions</span></div>

    <span class="c1"># async def move_joints(self, target, parameters):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Moves joints to target joint positions</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     target : JointValues</span>
    <span class="c1">#         target joint positions</span>
    <span class="c1">#     parameters : PlanParameters</span>
    <span class="c1">#         Plan parameters which defines the limits, settings</span>
    <span class="c1">#         and move group name</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     None</span>

    <span class="c1">#     Raises</span>
    <span class="c1">#     ------</span>
    <span class="c1">#     TypeError</span>
    <span class="c1">#         If target is not of type JointValues or</span>
    <span class="c1">#         if parameters is not of type PlanParameters</span>
    <span class="c1">#     ServiceException</span>
    <span class="c1">#         If query services are not available or finish</span>
    <span class="c1">#         with a fail state</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     if not isinstance(target, JointValues):</span>
    <span class="c1">#         raise TypeError(&#39;target is not of expected type JointValues&#39;)</span>

    <span class="c1">#     if not isinstance(parameters, PlanParameters):</span>
    <span class="c1">#         raise TypeError(&#39;parameters is not of expected&#39;</span>
    <span class="c1">#                         &#39; type PlanParameters&#39;)</span>

    <span class="c1">#     source = self.get_current_joint_values(parameters.joint_set)</span>
    <span class="c1">#     path = JointPath.from_start_stop_point(source, target)</span>
    <span class="c1">#     trajectory = self.plan_move_joints(path, parameters)</span>
    <span class="c1">#     await self.execute_joint_trajectory(trajectory, parameters.collision_check)</span>

    <span class="c1"># async def move_pose(self, target, end_effector_link, parameters, seed=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Moves to target pose</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     target : Pose</span>
    <span class="c1">#         target pose</span>
    <span class="c1">#     end_effector_link : str convertable</span>
    <span class="c1">#         specifies for which link the pose is defined</span>
    <span class="c1">#     parameters : PlanParameters</span>
    <span class="c1">#         Plan parameters which defines the limits, settings</span>
    <span class="c1">#         and move group name</span>
    <span class="c1">#     seed : JointValues or None</span>
    <span class="c1">#         numerical seed to control the robot configuration</span>
    <span class="c1">#         if none the current joint position is used</span>

    <span class="c1">#     Raises</span>
    <span class="c1">#     ------</span>
    <span class="c1">#     TypeError</span>
    <span class="c1">#         If target is not of type Pose</span>
    <span class="c1">#         If parameters is not of type PlanParameters</span>
    <span class="c1">#         If end_effector_link is not convertable to str</span>
    <span class="c1">#         If seed is not of type JointValues</span>
    <span class="c1">#     ServiceException</span>
    <span class="c1">#         If query services are not available or finish</span>
    <span class="c1">#         with a fail state</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     if not isinstance(target, Pose):</span>
    <span class="c1">#         raise TypeError(&#39;target is not of expected type Pose&#39;)</span>

    <span class="c1">#     if not seed:</span>
    <span class="c1">#         seed = self.get_current_joint_values(parameters.joint_set)</span>

    <span class="c1">#     joint_values = self.query_inverse_kinematics(target, parameters,</span>
    <span class="c1">#                                                  seed,</span>
    <span class="c1">#                                                  end_effector_link)</span>

    <span class="c1">#     await self.move_joints(joint_values, parameters)</span>

    <span class="c1"># async def move_pose_linear(self, target, end_effector_link, parameters, seed=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Moves to target pose linear</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     target : Pose</span>
    <span class="c1">#         target pose</span>
    <span class="c1">#     end_effector_link : str convertable</span>
    <span class="c1">#         specifies for which link the pose is defined</span>
    <span class="c1">#     parameters : TaskPlanParameters</span>
    <span class="c1">#         Task space plan parameters which defines the limits, settings</span>
    <span class="c1">#         and end effector name</span>
    <span class="c1">#     seed : JointValues</span>
    <span class="c1">#         numerical seed to control the robot configuration</span>

    <span class="c1">#     Raises</span>
    <span class="c1">#     ------</span>
    <span class="c1">#     TypeError</span>
    <span class="c1">#         If target is not of type Pose</span>
    <span class="c1">#         If parameters is not of type TaskSpacePlanParameters</span>
    <span class="c1">#         If end_effector_link is not convertable to str</span>
    <span class="c1">#         If seed is not of type JointValues or None</span>
    <span class="c1">#     ServiceException</span>
    <span class="c1">#         If query services are not available or finish</span>
    <span class="c1">#         with a fail state</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     groups = self.query_available_move_groups()</span>
    <span class="c1">#     group = next(g for g in groups</span>
    <span class="c1">#                  if any([parameters.end_effector_name in</span>
    <span class="c1">#                          g.end_effector_names]))</span>

    <span class="c1">#     if not group:</span>
    <span class="c1">#         raise RuntimeError(&#39;no move group is available with&#39;</span>
    <span class="c1">#                            &#39; requested end effector name: &#39; +</span>
    <span class="c1">#                            parameters.end_effector_name)</span>

    <span class="c1">#     if not seed:</span>
    <span class="c1">#         seed = self.get_current_joint_values(group.joint_set)</span>

    <span class="c1">#     source = self.query_pose(group.name, seed, end_effector_link)</span>
    <span class="c1">#     path = CartesianPath.from_start_stop_point(source, target)</span>
    <span class="c1">#     trajectory = self.plan_move_cartesian_linear(path, seed, parameters)</span>
    <span class="c1">#     await self.execute_joint_trajectory(trajectory,</span>
    <span class="c1">#                                         parameters.collision_check)</span>

<div class="viewcode-block" id="MotionService.move_gripper"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.move_gripper">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">move_gripper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">max_effort</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves a gripper via the general ros interface GripperCommandAction</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action_name : str convertable</span>
<span class="sd">            Name of the action to control a specific gripper</span>
<span class="sd">        position : float convertable</span>
<span class="sd">            Requested position of the gripper in meter</span>
<span class="sd">        max_effort : float convertable</span>
<span class="sd">            Force which should be applied</span>

<span class="sd">        Results</span>
<span class="sd">        -------</span>
<span class="sd">        action_response : MoveGripperResult</span>
<span class="sd">            Result of the action execution</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If inputs are not convertable to specified types</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If action server is not available</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If action returns unexpected result</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">action_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>

        <span class="n">action_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span>
                                                     <span class="n">GripperCommandAction</span><span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">GripperCommandGoal</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">max_effort</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_effort</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">action_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;connection to grippercommand action&#39;</span>
                                   <span class="s1">&#39; server with name: &#39;</span> <span class="o">+</span> <span class="n">action_name</span> <span class="o">+</span>
                                   <span class="s1">&#39; could not be established&#39;</span><span class="p">)</span>

        <span class="n">run_action</span> <span class="o">=</span> <span class="n">generate_action_executor</span><span class="p">(</span><span class="n">action_client</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">LeaseBaseLock</span><span class="p">([</span><span class="n">action_name</span><span class="p">]):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_action</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unexpected result received by&#39;</span>
                               <span class="s1">&#39; gripper command action: &#39;</span> <span class="o">+</span>
                               <span class="n">action_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">MoveGripperResult</span><span class="o">.</span><span class="n">from_gripper_command_action_result</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">())</span></div>

<div class="viewcode-block" id="MotionService.wsg_gripper_command"><a class="viewcode-back" href="../../source/motion_service.html#xamla_motion.motion_service.MotionService.wsg_gripper_command">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wsg_gripper_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_name</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span>
                                  <span class="n">max_effort</span><span class="p">,</span> <span class="n">stop_on_block</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Controls a WeissWsg gripper via the the specific action WsgCommandAction</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        action_name : str convertable</span>
<span class="sd">            Name of the action to control a specific gripper</span>
<span class="sd">        command : WsgCommand</span>
<span class="sd">            Specifies which kind of action should be performed</span>
<span class="sd">        width : float convertable</span>
<span class="sd">            Requested position of the gripper in meter</span>
<span class="sd">        speed : float convetable</span>
<span class="sd">            Requested speed in m/s</span>
<span class="sd">        max_effort : float convertable</span>
<span class="sd">            Force which should be applied</span>

<span class="sd">        Results</span>
<span class="sd">        -------</span>
<span class="sd">        action_response : MoveGripperResult</span>
<span class="sd">            Result of the action execution</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If inputs are not convertable to specified types</span>
<span class="sd">            or if command is no of type WsgCommand</span>
<span class="sd">        ServiceException</span>
<span class="sd">            If action server is not available</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If action returns unexpected result</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">wsg_50_common.msg</span> <span class="k">import</span> <span class="n">CommandAction</span><span class="p">,</span> <span class="n">CommandGoal</span>

        <span class="n">action_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">action_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">WsgCommand</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;command is not of expected type WsgCommand&#39;</span><span class="p">)</span>

        <span class="n">action_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span>
                                                     <span class="n">CommandAction</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">action_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ServiceException</span><span class="p">(</span><span class="s1">&#39;connection to wsg gripper action&#39;</span>
                                   <span class="s1">&#39; server with name: &#39;</span> <span class="o">+</span> <span class="n">action_name</span> <span class="o">+</span>
                                   <span class="s1">&#39; could not be established&#39;</span><span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">CommandGoal</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_id</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">value</span>
        <span class="n">g</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_effort</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">stop_on_block</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">stop_on_block</span><span class="p">)</span>

        <span class="n">run_action</span> <span class="o">=</span> <span class="n">generate_action_executor</span><span class="p">(</span><span class="n">action_client</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">LeaseBaseLock</span><span class="p">([</span><span class="n">action_name</span><span class="p">]):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_action</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unexpected result received by&#39;</span>
                               <span class="s1">&#39; wsg gripper command action: &#39;</span> <span class="o">+</span>
                               <span class="n">action_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">WsgResult</span><span class="o">.</span><span class="n">from_wsg_command_action_result</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">())</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Xamla

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>